<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Lua1 by wangfakang</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Lua1</h1>
        <p class="header">lua and c each call</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/wangfakang/lua1/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/wangfakang/lua1/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/wangfakang/lua1">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/wangfakang">wangfakang</a></p>


      </header>
      <section>
        <p><code>lua和c之间的交互：</code></p>

<p>Lua 使用一个虚拟栈来和 C 传递值。栈上的的每个元素都是一个 Lua 值（nil，数字，字符串，等等）。          </p>

<p>Lua可以调用C函数的能力将极大的提高Lua的可扩展性和可用性。对于有些和操作系统相关的功能，
或者是对效率要求较高的模块，我们完全可以通过C函数来实现，之后再通过Lua调用指定的C函数。
对于那些可被Lua调用的C函数而言，其接口必须遵循Lua要求的形式，即typedef int (<em>lua_CFunction)(lua_State</em> L)。
简单说明一下，该函数类型仅仅包含一个表示Lua环境的指针作为其唯一的参数，实现者可以通过该指针进一步获取Lua代码
中实际传入的参数。返回值是整型，表示该C函数将返回给Lua代码的返回值数量，如果没有返回值，则return 0即可。
需要说明的是，C函数无法直接将真正的返回值返回给Lua代码，而是通过虚拟栈来传递Lua代码和C函数之间的调用参数和返回值的
。这里我们将介绍两种Lua调用C函数的规则。      </p>

<h1>
<a id="下面是lua调用c---" class="anchor" href="#%E4%B8%8B%E9%9D%A2%E6%98%AFlua%E8%B0%83%E7%94%A8c---" aria-hidden="true"><span class="octicon octicon-link"></span></a>下面是lua调用c:   </h1>

<div class="highlight highlight-source-lua"><pre><span class="pl-k">#</span>include <span class="pl-k">&lt;</span>stdio.<span class="pl-smi">h</span><span class="pl-k">&gt;</span>
<span class="pl-k">#</span>include <span class="pl-k">&lt;</span>string.<span class="pl-smi">h</span><span class="pl-k">&gt;</span>
<span class="pl-k">#</span>include <span class="pl-k">&lt;</span>lua.<span class="pl-smi">hpp</span><span class="pl-k">&gt;</span>
<span class="pl-k">#</span>include <span class="pl-k">&lt;</span>lauxlib.<span class="pl-smi">h</span><span class="pl-k">&gt;</span>
<span class="pl-k">#</span>include <span class="pl-k">&lt;</span>lualib.<span class="pl-smi">h</span><span class="pl-k">&gt;</span>

<span class="pl-k">//</span>待Lua调用的C注册函数。
static int <span class="pl-c1">add2</span>(lua_State<span class="pl-k">*</span> L)
{
    <span class="pl-k">//</span>检查栈中的参数是否合法，<span class="pl-c1">1</span>表示Lua调用时的第一个参数(从左到右)，依此类推。
    <span class="pl-k">//</span>如果Lua代码在调用时传递的参数不为number，该函数将报错并终止程序的执行。
    double op1 <span class="pl-k">=</span> <span class="pl-c1">luaL_checknumber</span>(L,<span class="pl-c1">1</span>);
    double op2 <span class="pl-k">=</span> <span class="pl-c1">luaL_checknumber</span>(L,<span class="pl-c1">2</span>);
    <span class="pl-k">//</span>将函数的结果压入栈中。如果有多个返回值，可以在这里多次压入栈中。
    <span class="pl-c1">lua_pushnumber</span>(L,op1 <span class="pl-k">+</span> op2);
    <span class="pl-k">//</span>返回值用于提示该C函数的返回值数量，即压入栈中的返回值数量。
    <span class="pl-k">return</span> <span class="pl-c1">1</span>;
}

<span class="pl-k">//</span>另一个待Lua调用的C注册函数。
static int <span class="pl-c1">sub2</span>(lua_State<span class="pl-k">*</span> L)
{
    double op1 <span class="pl-k">=</span> <span class="pl-c1">luaL_checknumber</span>(L,<span class="pl-c1">1</span>);
    double op2 <span class="pl-k">=</span> <span class="pl-c1">luaL_checknumber</span>(L,<span class="pl-c1">2</span>);
    <span class="pl-c1">lua_pushnumber</span>(L,op1 <span class="pl-k">-</span> op2);
    <span class="pl-k">return</span> <span class="pl-c1">1</span>;
}

<span class="pl-k">//</span>此行相当于lua代码，下面函数luaL_dostring就是执行字符串的lua
const char<span class="pl-k">*</span> testfunc <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>print(add2(1.0,2.0)) print(sub2(20.1,19))<span class="pl-pds">"</span></span>;

int <span class="pl-c1">main</span>()
{
    lua_State<span class="pl-k">*</span> L <span class="pl-k">=</span> <span class="pl-c1">luaL_newstate</span>();
    <span class="pl-c1">luaL_openlibs</span>(L);
    <span class="pl-k">//</span>将指定的函数注册为Lua的全局函数变量，其中第一个字符串参数为Lua代码
    <span class="pl-k">//</span>在调用C函数时使用的全局函数名，第二个参数为实际C函数的指针。
    <span class="pl-c1">lua_register</span>(L, <span class="pl-s"><span class="pl-pds">"</span>add2<span class="pl-pds">"</span></span>, add2);
    <span class="pl-c1">lua_register</span>(L, <span class="pl-s"><span class="pl-pds">"</span>sub2<span class="pl-pds">"</span></span>, sub2);
    <span class="pl-k">//</span>在注册完所有的C函数之后，即可在Lua的代码块中使用这些已经注册的C函数了。
    <span class="pl-k">if</span> (<span class="pl-c1">luaL_dostring</span>(L,testfunc))
        <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>Failed to invoke.<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);
    <span class="pl-c1">lua_close</span>(L);
    <span class="pl-k">return</span> <span class="pl-c1">0</span>;
}</pre></div>

<h1>
<a id="下面是c调用lua" class="anchor" href="#%E4%B8%8B%E9%9D%A2%E6%98%AFc%E8%B0%83%E7%94%A8lua" aria-hidden="true"><span class="octicon octicon-link"></span></a>下面是c调用lua:</h1>

<p>C程序掉用Lua函数例子：</p>

<div class="highlight highlight-source-lua"><pre>void <span class="pl-c1">CCallLua</span>()
{
    <span class="pl-k">//</span> Create a LUA VMachine
    lua_State <span class="pl-k">*</span>L;

    <span class="pl-k">//</span>L <span class="pl-k">=</span> <span class="pl-c1">luaL_newstate</span>();
    L <span class="pl-k">=</span> <span class="pl-c1">lua_open</span>();

    <span class="pl-k">//</span>Load Libraries
    <span class="pl-c1">luaL_openlibs</span>(L);

     <span class="pl-k">//</span> 运行脚本 <span class="pl-k">/</span>
    <span class="pl-c1">luaL_dofile</span>(L, <span class="pl-s"><span class="pl-pds">"</span>clua.lua<span class="pl-pds">"</span></span>);

    <span class="pl-c1">lua_getglobal</span>(L,<span class="pl-s"><span class="pl-pds">"</span>Sum<span class="pl-pds">"</span></span>);

    <span class="pl-c1">lua_pushnumber</span>(L,<span class="pl-c1">2</span>);<span class="pl-k">//</span>第一个参数

    <span class="pl-c1">lua_pushnumber</span>(L,<span class="pl-c1">3</span>);<span class="pl-k">//</span>第二个参数

    <span class="pl-c1">lua_pushnumber</span>(L,<span class="pl-c1">4</span>);<span class="pl-k">//</span>第三个参数

    <span class="pl-c1">lua_pcall</span>(L,<span class="pl-c1">3</span>,<span class="pl-c1">2</span>,<span class="pl-c1">0</span>);<span class="pl-k">//</span><span class="pl-c1">3</span>表示参数个数　<span class="pl-c1">2</span>表示返回值个数 <span class="pl-c1">0</span>表示返回在栈顶的错误消息就和原始错误消息完全一致。

    double sum<span class="pl-k">=</span><span class="pl-c1">0</span>,ave<span class="pl-k">=</span><span class="pl-c1">0</span>;

    <span class="pl-k">if</span>(<span class="pl-c1">lua_isnumber</span>(L,<span class="pl-c1">1</span>))
    {
        sum<span class="pl-k">=</span><span class="pl-c1">lua_tonumber</span>(L,<span class="pl-c1">1</span>);
    }

    <span class="pl-k">if</span>(<span class="pl-c1">lua_isnumber</span>(L,<span class="pl-c1">2</span>))
    {
        ave<span class="pl-k">=</span><span class="pl-c1">lua_tonumber</span>(L,<span class="pl-c1">2</span>);
    }

    <span class="pl-c1">lua_pop</span>(L,<span class="pl-c1">2</span>);

    cout<span class="pl-k">&lt;&lt;</span><span class="pl-s"><span class="pl-pds">"</span>Sum =<span class="pl-pds">"</span></span><span class="pl-k">&lt;&lt;</span>sum

        <span class="pl-k">&lt;&lt;</span><span class="pl-s"><span class="pl-pds">"</span>/nAve =<span class="pl-pds">"</span></span><span class="pl-k">&lt;&lt;</span>ave<span class="pl-k">&lt;&lt;</span>endl;

    <span class="pl-k">//</span> 清除Lua
    <span class="pl-c1">lua_close</span>(L);

    <span class="pl-c1">getchar</span>();
}





Lua脚本Clua.<span class="pl-smi">lua</span>：


<span class="pl-k">function</span> <span class="pl-en">Sum</span>(<span class="pl-smi">...</span>)
  <span class="pl-k">local</span> s<span class="pl-k">=</span><span class="pl-c1">0</span>
  <span class="pl-k">local</span> num<span class="pl-k">=</span><span class="pl-c1">0</span>     
  <span class="pl-k">for</span> k,v <span class="pl-k">in</span> <span class="pl-c1">pairs</span>{<span class="pl-c1">...</span>} <span class="pl-k">do</span>
    s <span class="pl-k">=</span> s <span class="pl-k">+</span> v
       num <span class="pl-k">=</span> k
  <span class="pl-k">end</span>
  <span class="pl-k">return</span> s,s<span class="pl-k">/</span>num
<span class="pl-k">end</span></pre></div>

<ul>
<li><p>1 初始化Lua环境：<br>
Lua_open或者：lua_newstate            </p></li>
<li>
<p>2 加载Lua标准库：  Lua_openlibs(打开所有标准库)    </p>

<p>不打开所有库，打开需要的库:   </p>

<p>Luaopen_base  luaopen_package  luaopen_string  luaopen_table  luaopen_math ……….    </p>
</li>
<li>
<p>3 加载Lua和函数    </p>

<p>luaL_dofile()    </p>

<p>lua_getglobal()    </p>

<p>大小写敏感,名字于Lua脚本的函数名称大小写完全一致    </p>
</li>
<li>
<p>4 压入参数   </p>

<p>不同类型采用不同的函数，按照从左往右的顺序依次压栈   </p>

<p>lua_pushnumber，lua_pushstring，…..    </p>
</li>
<li>
<p>5 执行函数     </p>

<p>lua_call, lua_pcall   </p>
</li>
<li>
<p>6 获取返回值    </p>

<p>不同类型使用不同的函数，注意索引，获取前要检查类型      </p>

<p>从栈中弹出返回值  lua_pop()    </p>
</li>
<li>
<p>7 关闭Lua状态机   </p>

<p>lua_close()   </p>
</li>
</ul>

<h1>
<a id="欢迎一起交流学习-" class="anchor" href="#%E6%AC%A2%E8%BF%8E%E4%B8%80%E8%B5%B7%E4%BA%A4%E6%B5%81%E5%AD%A6%E4%B9%A0-" aria-hidden="true"><span class="octicon octicon-link"></span></a>欢迎一起交流学习 </h1>

<p>在使用中有任何问题，欢迎反馈给我，可以用以下联系方式跟我交流</p>

<ul>
<li>邮件(1031379296#qq.com, 把#换成@)</li>
<li>QQ: 1031379296</li>
<li>weibo: <a href="http://weibo.com/u/2786211992/home">@王发康</a>
</li>
</ul>

<h1>
<a id="thx" class="anchor" href="#thx" aria-hidden="true"><span class="octicon octicon-link"></span></a>Thx</h1>

<ul>
<li>chunshengsterATgmail.com</li>
</ul>

<h1>
<a id="author" class="anchor" href="#author" aria-hidden="true"><span class="octicon octicon-link"></span></a>Author</h1>

<ul>
<li>Linux\nginx\golang\c\c++爱好者</li>
<li>欢迎一起交流  一起学习# </li>
<li>Others say good and Others good</li>
</ul>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		          <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("lua and c each call [lua 与c之间的调用]");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
